<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{product.productName}}</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <style>
    .product-img-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 500px;
    }

    .product-img {
      max-width: 100%;
      height: auto;
      cursor: crosshair;
    }

    .zoomed-img {
      position: absolute;
      top: 0;
      left: 100%;
      width: 300px;
      height: 300px;
      border: 1px solid #ddd;
      background-repeat: no-repeat;
      background-size: 200% 200%;
      display: none;
      z-index: 10;
      pointer-events: none;
    }

    .thumbnail-img {
      width: 100px;
      height: auto;
      cursor: pointer;
      margin: 5px;
    }

    .thumbnail-container {
      display: flex;
      flex-wrap: wrap;
    }

    .error-message {
      color: red;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{product.productName}}</li>
      </ol>
    </nav>

    <div class="row product-details">
      <div class="col-md-6">
        <div class="product-img-wrapper">
          <img src="/{{product.images.[0]}}" alt="Product Image" class="product-img" id="product-image">
          <div class="zoomed-img" id="zoomed-image"></div>
        </div>
        <div class="thumbnail-container">
          {{#each product.images}}
            {{#if (lt @index 4)}}
              <img src="/{{this}}" alt="Product Thumbnail" class="thumbnail-img" onclick="changeMainImage('/{{this}}')">
            {{/if}}
          {{/each}}
        </div>
      </div>

      <div class="col-md-6">
        <h1>{{product.productName}}</h1>
        <div class="product-rating">
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star-half-alt"></i>
          <span>(4.5/5)</span>
        </div>
        <h2>{{product.price}} Rs <span class="text-muted"><s>400 Rs</s></span></h2>
        <p>Discount Applied: 25%</p>
        
        <p class="highlight">Highlights:</p>
        <ul>
          {{#each specificationsArray}}
            <li> {{this.value}}</li>
          {{/each}}
        </ul>

        <div class="error-message" id="stock-status">
          <!-- Stock status will be displayed here -->
        </div>

        <div class="mb-3">
          <button id="add-to-cart-btn" class="btn btn-primary" {{#if (eq product.quantity 0)}}disabled{{/if}}>Add to Cart</button>
          <button class="btn btn-secondary">Add to Wishlist</button>
        </div>

        <p><strong>Available Stock:</strong> {{product.quantity}}</p>
        <p><strong>Reviews:</strong> 120 Reviews</p>
        <p><strong>Discounts/Coupons Applied:</strong> 10% off with code SAVE10</p>
      </div>
    </div>

    <div class="mt-4">
      <h3>Customer Reviews</h3>
      <div class="review">
        <p><strong>Divya</strong> - <span class="text-muted">Jan 1, 2024</span></p>
        <div class="product-rating">
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star-half-alt"></i>
        </div>
        <p>Great product! Highly recommend.</p>
      </div>
      <div class="review">
        <p><strong>Sana</strong> - <span class="text-muted">Jan 2, 2024</span></p>
        <div class="product-rating">
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
          <i class="fas fa-star"></i>
        </div>
        <p>Excellent quality and fast shipping.</p>
      </div>
    </div>

    <div class="mt-4">
      <h3>Related Products</h3>
      <div class="row related-products">
        {{#each relatedProducts}}
          <div class="col-md-3">
            <div class="card">
              <img src="/{{this.images.[0]}}" class="card-img-top" alt="Related Product">
              <div class="card-body">
                <h5 class="card-title">{{this.productName}}</h5>
                <p class="card-text">{{this.price}} Rs</p>
                <a href="/productDetails/{{this._id}}" class="btn btn-primary">View Details</a>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    </div>
  </div>

  <script>
    const stockStatus = document.getElementById('stock-status');
    const stockQuantity = {{ product.quantity }};

    if (stockQuantity === 0) {
      stockStatus.innerText = 'Sold Out';
      stockStatus.classList.add('error-message');
    } else if (stockQuantity < 10) {
      stockStatus.innerText = 'Low Stock';
      stockStatus.classList.add('error-message');
    } else {
      stockStatus.innerText = '';
      stockStatus.classList.remove('error-message');
    }

    const productImage = document.getElementById('product-image');
    const zoomedImage = document.getElementById('zoomed-image');

    productImage.addEventListener('mousemove', (e) => {
      const rect = productImage.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const offsetX = (x / productImage.width) * 100;
      const offsetY = (y / productImage.height) * 100;

      zoomedImage.style.backgroundImage = `url(${productImage.src})`;
      zoomedImage.style.backgroundSize = `${productImage.width * 2}px ${productImage.height * 2}px`; // Zoom in size
      zoomedImage.style.backgroundPosition = `-${offsetX * 7}px -${offsetY * 7}px`; // Adjust for zoom
    });

    productImage.addEventListener('mouseleave', () => {
      zoomedImage.style.display = 'none';
    });

    productImage.addEventListener('mouseenter', () => {
      zoomedImage.style.display = 'block';
    });

    // JavaScript to change main image
    function changeMainImage(imageSrc) {
      productImage.src = `${imageSrc}`;
      zoomedImage.style.backgroundImage = `url(${productImage.src})`;
    }

    document.getElementById('add-to-cart-btn').addEventListener('click', async () => {
      try {
        const response = await fetch('/addToCart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ productId: '{{product._id}}', quantity: 1 })
        });
        const data = await response.json();

        if (response.status !== 200) {
          stockStatus.innerText = data.message;
          stockStatus.classList.add('error-message');
        } else {
          stockStatus.innerText = 'Added to Cart!';
          stockStatus.classList.remove('error-message');
           window.location.href = '/yourCart';
        }
      } catch (error) {
        stockStatus.innerText = 'Error adding to cart';
        stockStatus.classList.add('error-message');
      }
    });
  </script>
</body>

</html>
